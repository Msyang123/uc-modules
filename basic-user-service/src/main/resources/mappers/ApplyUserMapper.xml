<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lhiot.uc.basic.mapper.ApplyUserMapper">

	<select id="countByPhoneNumber" parameterType="com.lhiot.uc.basic.entity.ApplyUser" resultType="Integer">
		SELECT count(id) FROM apply_user WHERE phone = #{phone} AND apply = #{apply}
	</select>

	<select id="countByOpenId" parameterType="String" resultType="Integer">
		SELECT COUNT(id) FROM apply_user WHERE open_id = #{0}
	</select>

    <select id="countById" parameterType="Long" resultType="Integer">
        SELECT count(id) FROM apply_user WHERE id = #{0}
    </select>

	<insert id="save" parameterType="com.lhiot.uc.basic.entity.ApplyUser">
		INSERT INTO apply_user(id,phone,open_id,union_id,base_user_id,password,payment_password,nickname,avatar,email,qq,address,description,apply,sex,
		birthday,register_at,payment_permissions)
		VALUE (#{id},#{phone},#{openId},#{unionId},#{baseUserId},#{password},#{paymentPassword},#{nickname},#{avatar},#{email},#{qq}
		,#{address},#{description},#{apply},#{sex},#{birthday},NOW(),#{paymentPermissions})
	</insert>

    <select id="findById" parameterType="Long" resultType="com.lhiot.uc.basic.model.UserDetailResult">
		SELECT a.id,a.phone,open_id,union_id,base_user_id,password,payment_password,nickname,avatar,email,qq,address,description,apply,sex
		,birthday,payment_permissions,register_at,currency,member_points,
		CASE b.locked
		WHEN 'LOCK' THEN b.locked
		ELSE a.locked
		END locked
		FROM apply_user a
		LEFT JOIN base_user b ON a.base_user_id = b.id
		WHERE a.id = #{0}
	</select>

	<select id="findByOpenId" parameterType="String" resultType="com.lhiot.uc.basic.model.UserDetailResult">
		SELECT id,phone,open_id,union_id,base_user_id,password,payment_password,nickname,avatar,email,qq,address,description,apply,sex
		,birthday,payment_permissions,register_at,currency,member_points,
		CASE b.locked
		WHEN 'LOCK' THEN b.locked
		ELSE a.locked
		END locked
		FROM apply_user a
		LEFT JOIN base_user b ON a.base_user_id = b.id
		WHERE a.open_id = #{0}
	</select>

	<select id="findByPhone" parameterType="com.lhiot.uc.basic.entity.ApplyUser" resultType="com.lhiot.uc.basic.model.UserDetailResult">
		SELECT id,phone,open_id,union_id,base_user_id,password,payment_password,nickname,avatar,email,qq,address,description,apply,sex
		,birthday,payment_permissions,register_at,currency,member_points,
		CASE b.locked
		WHEN 'LOCK' THEN b.locked
		ELSE a.locked
		END locked
		FROM apply_user a
		LEFT JOIN base_user b ON a.base_user_id = b.id
		WHERE a.phone = #{phone} AND a.apply = #{apply}
	</select>

	<select id="findByIdList" parameterType="list" resultType="com.lhiot.uc.basic.model.UserDetailResult">
		SELECT id,phone,open_id,union_id,base_user_id,password,payment_password,nickname,avatar,email,qq,address,description,apply,sex
		,birthday,payment_permissions,register_at,currency,member_points,
		CASE b.locked
		WHEN 'LOCK' THEN b.locked
		ELSE a.locked
		END locked
		FROM apply_user a
		LEFT JOIN base_user b ON a.base_user_id = b.id
		WHERE a.id IN
		<foreach collection="list" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</select>

	<select id="findByPhoneList" parameterType="list" resultType="com.lhiot.uc.basic.model.UserDetailResult">
		SELECT id,phone,open_id,union_id,base_user_id,password,payment_password,nickname,avatar,email,qq,address,description,apply,sex
		,birthday,payment_permissions,register_at,currency,member_points,
		CASE b.locked
		WHEN 'LOCK' THEN b.locked
		ELSE a.locked
		END locked
		FROM apply_user a
		LEFT JOIN base_user b ON a.base_user_id = b.id
		WHERE a.phone IN
		<foreach collection="list" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</select>
	
	<select id="findByKeyword" parameterType="String" resultType="com.lhiot.uc.basic.entity.ApplyUser">
		SELECT id ,birthday,sex,phone,nickname,email,qq,avatar,address,description,register_at
		FROM apply_user
		WHERE
		phone  LIKE #{0} OR nickname LIKE #{0};
	</select>
    
    <update id="updateUserById" parameterType="com.lhiot.uc.basic.entity.ApplyUser" >
        UPDATE apply_user
        <trim prefix="set" suffixOverrides=",">
            <if test="phone != null and phone != ''">phone = #{phone},</if>
            <if test="birthday != null and birthday != ''">birthday = #{birthday},</if>
            <if test="sex != null and sex != 'man'">sex = #{sex},</if>
            <if test="nickname != null and nickname != ''">nickname = #{nickname},</if>
            <if test="email != null and email != ''">email = #{email},</if>
            <if test="qq != null and qq != ''">qq = #{qq},</if>
            <if test="avatar != null and avatar != ''">avatar = #{avatar},</if>
            <if test="address != null and address != ''">address = #{address},</if>
            <if test="description != null and description != ''">description = #{description},</if>
			<if test="password != null and password != ''">password = #{password},</if>
			<if test="paymentPassword != null and paymentPassword != ''">payment_password = #{paymentPassword},</if>
			<if test="openId != null and openId != ''">open_id = #{openId},</if>
			<if test="unionId != null and unionId != ''">union_id = #{unionId},</if>
			<if test="paymentPermissions != null ">payment_permissions = #{paymentPermissions},</if>
			<if test="baseUserId != null and baseUserId != ''">base_user_id = #{baseUserId},</if>
        </trim>
		WHERE id = #{id}
    </update>
</mapper>